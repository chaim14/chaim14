"use strict";var __awaiter=this&&this.__awaiter||function(e,a,u,i){return new(u=u||Promise)(function(s,r){function n(e){try{o(i.next(e))}catch(e){r(e)}}function t(e){try{o(i.throw(e))}catch(e){r(e)}}function o(e){var r;e.done?s(e.value):((r=e.value)instanceof u?r:new u(function(e){e(r)})).then(n,t)}o((i=i.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(s,n){var t,o,a,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:r(0),throw:r(1),return:r(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(t)throw new TypeError("Generator is already executing.");for(;u;)try{if(t=1,o&&(a=2&r[0]?o.return:r[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,r[1])).done)return a;switch(o=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return u.label++,{value:r[1],done:!1};case 5:u.label++,o=r[1],r=[0];continue;case 7:r=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===r[0]||2===r[0])){u=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){u.label=r[1];break}if(6===r[0]&&u.label<a[1]){u.label=a[1],a=r;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(r);break}a[2]&&u.ops.pop(),u.trys.pop();continue}r=n.call(s,u)}catch(e){r=[6,e],o=0}finally{t=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}};exports.__esModule=!0,exports.login=exports.deleteUser=exports.updateUser=exports.addUser=exports.getAllUsers=void 0;var jwt_simple_1=require("jwt-simple"),usersModel_1=require("../model/usersModel"),secret=process.env.JWT_SECRET;function getAllUsers(o,a){return __awaiter(this,void 0,void 0,function(){var r,s,n,t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),console.log(o.cookies),r=o.cookies.userInfo,console.log(r),s=jwt_simple_1.default.decode(r,secret),console.log(s),s&&"admin"===s.role?[4,usersModel_1.default.find({})]:[3,2];case 1:return n=e.sent(),a.send({ok:!0,users:n}),[2];case 2:throw new Error("user is not allowed");case 3:return t=e.sent(),console.log("Error on getAllUsers:",t.message),a.send({error:t.message}),[3,4];case 4:return[2]}})})}exports.getAllUsers=getAllUsers,exports.addUser=function(a,u){return __awaiter(void 0,void 0,void 0,function(){var r,s,n,t,o;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),r=a.body,s=r.username,n=r.password,[4,new usersModel_1.default({username:s,password:n}).save()];case 1:return t=e.sent(),u.send({result:t}),[3,3];case 2:return o=e.sent(),console.error(o),u.send({error:o.message}),[3,3];case 3:return[2]}})})},exports.updateUser=function(a,u){return __awaiter(void 0,void 0,void 0,function(){var r,s,n,t,o;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),r=a.body,s=r.userId,n=r.role,s&&n?[4,usersModel_1.default.updateOne({_id:s},{role:n})]:[3,2];case 1:return t=e.sent(),u.send({ok:!0,users:t}),[3,3];case 2:throw new Error("userId or role is missing");case 3:return[3,5];case 4:return o=e.sent(),console.log(o.error),u.send({error:o.message}),[3,5];case 5:return[2]}})})},exports.deleteUser=function(t,o){return __awaiter(void 0,void 0,void 0,function(){var r,s,n;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),r=t.body.userId,console.log(r),r?[4,usersModel_1.default.deleteOne({_id:r})]:[3,2];case 1:return s=e.sent(),o.send({ok:!0,users:s}),[3,3];case 2:throw new Error("userId or role is missing");case 3:return[3,5];case 4:return n=e.sent(),console.log(n.error),o.send({error:n.message}),[3,5];case 5:return[2]}})})},exports.login=function(i,l){return __awaiter(void 0,void 0,void 0,function(){var r,s,n,t,o,a,u;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),r=i.body,s=r.username,n=r.password,console.log(s,n),"string"!=typeof s||"string"!=typeof n?[3,2]:[4,usersModel_1.default.findOne({username:s})];case 1:if((t=e.sent())&&t.password===n)return l.cookie("userInfo",{username:s,id:t._id,role:t.role},{maxAge:12e4}),o={username:s,id:t._id,role:t.role},a=jwt_simple_1.default.encode(o,secret),l.cookie("userInfo",a,{maxAge:36e4}),l.send({ok:!0,login:!0}),[2];throw new Error("username or password are inncorect");case 2:throw new Error("user name or password are missing or role is missing");case 3:return[3,5];case 4:return u=e.sent(),console.log(u.message),l.send({error:u.message}),[3,5];case 5:return[2]}})})};